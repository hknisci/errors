Ekrandaki hata şu:

Error from server (BadRequest): container ENV is not valid for pod ...

Bu kesin olarak şunu gösterir: Script oc exec ... -c ENV şeklinde çalıştırmış. Yani script container adını yanlış parse edip “ENV” diye bir container var sanmış.

Bu da senin son eklediğin dc_first_container_name_from_yaml() awk’ının containers blok yerine env bloktaki - name: ENV satırını yakalamasından kaynaklanıyor. YAML parse etmeye çalışınca böyle “false positive” çok oluyor.

✅ En sağlam çözüm: container adını YAML parse ederek değil, OpenShift API’den jsonpath ile çekmek.

⸻

1) Hızlı doğrulama (1 komut)

Şu podun container adları neymiş bir gör:

oc get pod -n accounts-dev digital-accounts-composition-v0-5-h78f7 -o jsonpath='{.spec.containers[*].name}{"\n"}'

Burada “ENV” çıkmayacak; gerçek container ad(lar)ını göreceksin.

⸻

2) Script fix (önerilen net fix)

A) Şu fonksiyonu EKLE (dc_first_container_name_from_yaml’ı kullanma)

Scriptte uygun yere ekle:

# DC'den gerçek container adını API üzerinden çek (yaml parse yok!)
get_dc_first_container_name() {
  local ns="$1"
  local dc="$2"
  local name
  name="$(run_cmd "$ns" "$dc" 1 -- oc get dc -n "$ns" "$dc" -o jsonpath='{.spec.template.spec.containers[0].name}' || true)"
  name="$(echo "$name" | tr -d '\r' | tr -d '\n')"
  echo "$name"
}

B) Şu satırı DEĞİŞTİR

Scriptte container_name hesapladığın yer var:

Eski (hatalı):

container_name="$(printf "%s" "$dc_yaml" | dc_first_container_name_from_yaml)"
[[ -z "$container_name" ]] && container_name="$dc"

Yeni (doğru):

container_name="$(get_dc_first_container_name "$ns" "$dc")"
[[ -z "$container_name" ]] && container_name="$dc"

C) Post-check tarafında da aynısını yap

Post-check içinde şu vardı:

Eski:

container_name2="$(printf "%s" "$dc_yaml2" | dc_first_container_name_from_yaml)"

Yeni:

container_name2="$(get_dc_first_container_name "$ns" "$dc")"
[[ -z "$container_name2" ]] && container_name2="$container_name"

Not: Bu şekilde container adı “ENV” gibi saçma bir değere asla dönmez; doğrudan cluster’dan doğru değeri alır.

⸻

3) İstersen “yaml parse” fonksiyonunu tamamen kaldır

dc_first_container_name_from_yaml() fonksiyonunu ya sil ya da kullanılmadığından emin ol. Asıl problem orası.

⸻

4) Mini ek güvenlik (çok öneririm)

oc exec hatası olursa log’a podun container listesini de yazdır:

run_cmd "$ns" "$dc" 0 -- oc get pod -n "$ns" "$pod_name" -o jsonpath='{.spec.containers[*].name}{"\n"}' || true

Bu sayede bir daha benzer durumda anında görürsün.

⸻

İstersen sen bana şu iki çıktıyı yapıştır:
	1.	oc get dc -n accounts-dev digital-accounts-composition-v0 -o jsonpath='{.spec.template.spec.containers[*].name}{"\n"}'
	2.	oc get pod -n accounts-dev digital-accounts-composition-v0-5-h78f7 -o jsonpath='{.spec.containers[*].name}{"\n"}'

Ben de scriptte tam doğru yerde hangi block içinde değiştireceğini sana “diff/patch” formatında nokta atışı veririm.