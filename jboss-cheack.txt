Aşağıdaki metni, Mahmut’un maddelerine tek tek yanıt veren kısa ve teknik bir mail olarak doğrudan gönderebilirsin.

⸻

Konu: GBSTPPAYMENTSYSAPPLY – Session birikimi / GC davranışı değerlendirmesi

Merhaba,

Mahmut’un paylaştığı bulgular üzerinden maddeler halinde değerlendirmemiz aşağıdadır:

1) Dump’ta InMemorySessionManager / ConcurrentHashMap’in heap’i doldurması
Undertow’un InMemorySessionManager yapısı aktif session’ları ConcurrentHashMap içinde tutar. Heap büyümesi, GC’nin silememesinden ziyade session nesnelerinin hâlâ referanslı ve “aktif” görünmesinden kaynaklanır. Bu durum genellikle:
	•	istemciden JSESSIONID cookie geri gelmediği için her istekte yeni session oluşturulması,
	•	session timeout dolmadan sürekli erişim (touch) edilmesi,
	•	veya session attribute’larında büyük objelerin tutulması

durumlarında görülür.

2) “GC kullanılmayan nesneleri silmeli, ancak burada silinmiyor” gözlemi
GC yalnızca referansı kalmayan nesneleri temizler. Session nesneleri InMemorySessionManager map’inde referanslı kaldığı sürece GC tarafından silinmez. Bu nedenle problem GC değil, session lifecycle’ının tamamlanmaması veya sürekli erişim nedeniyle expire olmamasıdır.

3) Objelerin G1 Old Gen içinde birikmesi
Session objeleri uzun süre yaşamaya devam ettiğinde young generation’dan old generation’a taşınmaları normaldir. Sürekli yeni session üretilmesi veya mevcut session’ların aktif kalması Old Gen doluluğunu artırır ve GC sürelerinde uzamaya yol açabilir.

4) Restart sonrası düzelip tekrar artış gözlenmesi
Restart ile heap ve session map sıfırlanır; ancak kök neden devam ediyorsa (ör. cookie geri dönmemesi, sticky session problemi veya uygulama tarafında sürekli session üretimi) aynı büyüme paterni yeniden oluşur. Bu durum bellek sızıntısından ziyade session sayısının kontrolsüz artışına işaret eder.

5) Ankara ortamında da artış görülmesi
Yük oranı farklı olsa da artışın her node’da gözlenmesi, session üretim davranışının uygulama veya istemci taraflı olduğunu; yalnızca tek bir node’a özgü bir durum olmadığını gösterir.

6) Timeout eklenmesine rağmen session’ların silinmiyor gibi görünmesi
Session timeout süresi dolsa bile aşağıdaki durumlarda expiration gerçekleşmeyebilir:
	•	session’a periyodik erişim (health check, otomatik refresh, monitoring çağrıları),
	•	sticky session olmaması nedeniyle farklı node’larda yeni session oluşması,
	•	tarayıcı/istemci tarafında session’ın sürekli yeniden kullanılması.

Local testlerde sayfa yenileme veya arka plan çağrıları session’ı “aktif” tuttuğundan, timeout dolmuyormuş gibi bir izlenim oluşabilir.

7) JBoss 7’de görülmeyip JBoss 8’de görünmesi
JBoss 8 ile Undertow ve cookie politikalarında (SameSite, Secure, path/domain davranışı vb.) değişiklikler daha belirgin hale gelmiştir. Upgrade sonrası cookie’nin istemci tarafından geri gönderilmemesi veya route/stickiness davranışının değişmesi durumunda her istekte yeni session üretimi tetiklenebilir. Bu nedenle durum JBoss 8’in session silmemesinden ziyade session sürekliliğinin bozulması ile ilişkilidir.

Özetle:
Mevcut bulgular, klasik bir bellek sızıntısından çok session’ların expire olmadan birikmesi durumunu işaret etmektedir. Öncelikli olarak JSESSIONID cookie akışı, sticky session davranışı ve uygulamanın gereksiz session üretip üretmediği doğrulanmalıdır.

Teşekkürler.

⸻

İstersen bir sonraki adımda bunu daha kısa versiyon veya daha teknik/sert versiyon olarak da optimize edebilirim.