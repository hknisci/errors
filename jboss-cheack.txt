Aşağıdaki metni 7. maddeyi kaynak ve referanslarla güçlendirilmiş şekilde yeniden düzenleyerek gönderebilirsin:

⸻

Konu: GBSTPPAYMENTSYSAPPLY – Session birikimi ve GC davranışı değerlendirmesi

Merhaba,

Mahmut’un paylaştığı bulgular kapsamında sunucu üzerinde yaptığımız kontroller ve teknik değerlendirme aşağıdadır.

⸻

1) InMemorySessionManager / ConcurrentHashMap heap kullanımı

Undertow aktif session’ları JVM heap içerisinde InMemorySessionManager yapısı altında ve ConcurrentHashMap üzerinden tutmaktadır. GC yalnızca referansı kalmayan nesneleri temizlediğinden, session nesneleri bu map içinde referanslı kaldıkları sürece silinmezler.

Runtime doğrulaması için alınan histogram çıktısı:

jcmd <PID> GC.class_histogram | egrep -i "InMemorySessionManager\\$SessionImpl|ConcurrentHashMap" | head -n 30

Örnek çıktıda:
	•	116.932 adet ConcurrentHashMap$Node
	•	31.281 adet ConcurrentHashMap
	•	cache ve session yönetimi ile ilişkili ConcurrentHashMap yapıları

görülmektedir.

Bu durum session verilerinin heap içinde tutulduğunu ve GC tarafından temizlenmemesinin referans devamlılığından kaynaklandığını göstermektedir.

⸻

2) GC’nin temizlememesi davranışı

Bu durum GC kaynaklı bir problem değildir. Session nesneleri hâlâ referanslı olduğu için GC tarafından silinmez. Uzun süre yaşayan session nesnelerinin Old Generation’a taşınması JVM açısından normal davranıştır.

WAR içeriğinde session-timeout tanımı bulunmamaktadır:

grep -Rni "session-timeout" WEB-INF/web.xml

Timeout tanımlı olmadığında container varsayılan timeout değeri geçerli olur ve aktif erişim devam ettiği sürece session yaşamaya devam eder.

⸻

3) Restart sonrası düzelip tekrar artış görülmesi

Restart sonrası heap ve session map sıfırlanır. Ancak kök neden devam ediyorsa (yeni session üretimi veya mevcut session’ların expire olmaması) aynı büyüme paterni yeniden oluşur. Bu davranış klasik memory leak’ten ziyade session birikimi ile uyumludur.

⸻

4) Ankara ortamında da artış görülmesi

Benzer heap davranışının diğer node’larda da gözlenmesi, durumun tek bir sunucuya özgü olmadığını; session yönetimi veya yönlendirme davranışı ile ilişkili olabileceğini göstermektedir.

⸻

5) Sticky yönlendirme ve session sürekliliği

Apache tarafında sticky yönlendirme tanımlı olmakla birlikte, backend node route bilgisinin doğrulanması gerekmektedir. Route bilgisi olmadan yük dengeleyici istemciyi aynı node’a yönlendiremeyebilir ve aynı kullanıcı için birden fazla session oluşabilir.

Kontrol için:

grep -Rni "BalancerMember" /usr/apache/conf.d/GBSTPPAYMENTSYSAPPLY.conf
grep -Rni "jboss.node.name\|instance-id" $EAP_HOME/domain/configuration


⸻

6) Session timeout uygulanmasına rağmen silinmiyor görünmesi

Timeout dolmasına rağmen session’ların aktif kalması aşağıdaki durumlarda mümkündür:
	•	session’a periyodik erişim (refresh, health check vb.),
	•	sticky yönlendirme doğru çalışmuyorsa farklı node’larda yeni session oluşması,
	•	istemcinin session’ı sürekli yeniden kullanması.

⸻

7) JBoss 7 → JBoss 8 sonrası görünür hale gelmesi (Undertow & cookie davranışı)

JBoss EAP 8, Undertow tabanlı web container ve Jakarta EE 10 geçişi ile birlikte session yönetimi, cookie güvenlik politikaları ve routing davranışlarında daha katı ve standart uyumlu davranışlar sergilemektedir. Bu değişiklikler, önceki sürümlerde fark edilmeyen session sürekliliği sorunlarının görünür hale gelmesine neden olabilir.

Özellikle:
	•	SameSite cookie politikalarının modern tarayıcılar tarafından zorunlu uygulanması
	•	Secure flag gereksinimleri
	•	Undertow’un session cookie ve routing davranışlarının RFC standartlarına daha sıkı uyumu
	•	mod_cluster ve load balancer entegrasyonunda route/cookie uyumunun önem kazanması

Bu durum, cookie’nin istemci tarafından geri gönderilmemesi veya sticky yönlendirmenin doğru çalışmaması halinde her istekte yeni session oluşmasına neden olabilir.

Referanslar:
	•	Red Hat JBoss EAP 8 Migration Guide
https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/8.0/html/migration_guide/
	•	Red Hat JBoss EAP 8 Configuration Guide (Undertow & Web subsystem)
https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/8.0/html/configuration_guide/
	•	Undertow Documentation – Session Handling
https://undertow.io/undertow-docs/undertow-docs-2.3.0/index.html#sessions
	•	SameSite Cookie Changes (modern browser behavior)
https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite
	•	Red Hat KB: Sticky session & mod_cluster behavior
https://access.redhat.com/solutions/2306591

⸻

Özet

Mevcut bulgular GC kaynaklı bir bellek sızıntısından ziyade session nesnelerinin expire olmadan birikmesine işaret etmektedir.

Aşağıdaki noktaların doğrulanması önerilir:
	•	JSESSIONID cookie sürekliliğinin kontrolü
	•	Sticky yönlendirmenin etkin çalıştığının doğrulanması
	•	Uygulama tarafında gereksiz session oluşturulup oluşturulmadığının incelenmesi

Teşekkürler.